# 项目架构说明

## 一、整体架构

本项目采用**SpringCloud Alibaba**微服务架构，基于**DDD（领域驱动设计）**模式开发。

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                      API Gateway                         │
│                    (Spring Cloud Gateway)                │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
│ Auth Service │  │ User Service  │  │Order Service │
│  (认证服务)   │  │  (用户服务)   │  │  (订单服务)   │
└───────┬──────┘  └───────┬──────┘  └───────┬──────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
│   Nacos      │  │    Redis     │  │    MySQL    │
│ (注册中心)    │  │   (缓存)     │  │   (数据库)   │
└──────────────┘  └──────────────┘  └──────────────┘
```

## 二、DDD分层架构

每个微服务采用DDD四层架构：

```
service/
├── domain/              # 领域层（核心业务逻辑）
│   ├── model/          # 领域模型（实体、值对象）
│   ├── repository/      # 仓储接口（定义数据访问）
│   └── service/        # 领域服务（复杂业务逻辑）
├── application/         # 应用层（用例编排）
│   ├── service/        # 应用服务（用例实现）
│   └── dto/            # 数据传输对象
├── infrastructure/     # 基础设施层（技术实现）
│   ├── repository/     # 仓储实现（数据访问实现）
│   ├── mapper/         # MyBatis Mapper
│   └── po/             # 持久化对象
└── interfaces/          # 接口层（对外暴露）
    └── controller/     # REST控制器
```

### 各层职责

1. **领域层（Domain Layer）**
   - 包含核心业务逻辑
   - 领域模型：实体、值对象、聚合根
   - 领域服务：复杂业务逻辑
   - 仓储接口：定义数据访问契约

2. **应用层（Application Layer）**
   - 用例编排和协调
   - 应用服务：实现业务用例
   - DTO：数据传输对象

3. **基础设施层（Infrastructure Layer）**
   - 技术实现细节
   - 仓储实现：数据访问具体实现
   - 外部服务调用

4. **接口层（Interfaces Layer）**
   - 对外暴露API
   - REST控制器
   - 参数校验

## 三、核心组件说明

### 1. 分布式锁组件（component-distributed-lock）
- **实现**: 基于Redisson
- **功能**: 
  - 分布式锁获取和释放
  - 支持注解方式使用
  - 支持锁超时和等待时间配置

### 2. 分布式事务组件（component-distributed-transaction）
- **实现**: 基于Seata
- **功能**: 
  - AT模式分布式事务
  - 支持跨服务事务管理

### 3. 分库分表组件（component-sharding）
- **实现**: 基于ShardingSphere
- **功能**: 
  - 数据库分片
  - 读写分离

### 4. 消息队列组件（component-message）
- **实现**: 基于RocketMQ
- **功能**: 
  - 消息发送
  - 消息消费
  - 延迟消息

### 5. 数据搜索组件（component-search）
- **实现**: 基于Elasticsearch
- **功能**: 
  - 全文搜索
  - 索引管理
  - 文档CRUD

### 6. 服务监控组件（component-monitor）
- **实现**: 基于Sentinel + Actuator
- **功能**: 
  - 服务监控
  - 流量控制
  - 熔断降级

### 7. 加密解密组件（component-encrypt）
- **功能**: 
  - AES加密/解密
  - MD5/SHA256哈希
  - Base64编码/解码

### 8. 链路跟踪组件（component-trace）
- **实现**: 基于Sleuth
- **功能**: 
  - 分布式链路跟踪
  - 请求追踪

### 9. 敏感词组件（component-sensitive）
- **实现**: DFA算法
- **功能**: 
  - 敏感词检测
  - 敏感词替换

### 10. 国际化组件（component-i18n）
- **功能**: 
  - 多语言支持
  - 消息国际化

### 11. 限流组件（component-rate-limit）
- **功能**: 
  - 令牌桶算法
  - 滑动窗口限流
  - 注解方式使用

### 12. 缓存组件（component-cache）
- **实现**: 基于Redis
- **功能**: 
  - 多级缓存
  - 缓存管理

### 13. 单点登录组件（component-sso）
- **实现**: 基于JWT + Redis
- **功能**: 
  - Token生成和验证
  - 多服务器支持
  - 登出功能

## 四、服务说明

### 1. 网关服务（gateway）
- **端口**: 8080
- **功能**: 
  - 路由转发
  - 统一入口
  - 跨域处理

### 2. 认证服务（auth-service）
- **端口**: 8081
- **功能**: 
  - 多种登录方式
  - Token管理
  - 验证码发送

### 3. 用户服务（user-service）
- **端口**: 8082
- **功能**: 
  - 用户管理
  - 角色管理
  - 权限管理

### 4. 订单服务（order-service）
- **端口**: 8083
- **功能**: 
  - 订单创建
  - 订单管理
  - 消息发送

### 5. 秒杀服务（seckill-service）
- **端口**: 8084
- **功能**: 
  - 秒杀活动
  - 库存管理
  - 限流保护

## 五、技术选型

| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 2.7.18 | 基础框架 |
| Spring Cloud | 2021.0.8 | 微服务框架 |
| Spring Cloud Alibaba | 2021.0.5.0 | 阿里云组件 |
| Nacos | 2.0+ | 服务注册与配置中心 |
| Seata | 1.6.1 | 分布式事务 |
| RocketMQ | 4.9+ | 消息队列 |
| Redis/Redisson | 5.0+/3.23.3 | 缓存、分布式锁 |
| MyBatis Plus | 3.5.3.1 | 数据持久化 |
| ShardingSphere | 5.3.2 | 分库分表 |
| Elasticsearch | 7.0+ | 数据搜索 |
| Sentinel | - | 服务监控 |
| JWT | 0.11.5 | Token认证 |

## 六、数据流

### 登录流程
```
客户端 → 网关 → 认证服务 → 数据库
                ↓
            生成Token → Redis缓存
                ↓
            返回Token给客户端
```

### 秒杀流程
```
客户端 → 网关 → 秒杀服务
                ↓
            限流检查
                ↓
            分布式锁获取
                ↓
            库存扣减（Redis）
                ↓
            发送消息（RocketMQ）
                ↓
            返回结果
```

## 七、部署说明

### 开发环境
1. 启动Nacos
2. 启动Redis
3. 启动MySQL
4. 执行SQL脚本
5. 启动各微服务

### 生产环境
1. 使用Docker部署基础设施
2. 使用K8s部署微服务
3. 配置负载均衡
4. 配置监控告警

## 八、扩展性

- **水平扩展**: 支持多实例部署
- **服务拆分**: 可按业务域继续拆分
- **组件复用**: 各组件可独立使用
- **技术升级**: 支持技术栈升级

