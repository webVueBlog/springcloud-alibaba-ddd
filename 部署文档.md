# 部署文档

## 一、开发环境部署

### 1. 使用Docker Compose（推荐）

```bash
# 启动基础设施（MySQL、Redis、Nacos）
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 2. 手动部署

参考 [快速开始.md](快速开始.md)

## 二、生产环境部署

### 1. 服务器要求

- **CPU**: 4核以上
- **内存**: 8GB以上
- **磁盘**: 50GB以上
- **操作系统**: Linux (CentOS 7+ / Ubuntu 18+)

### 2. 环境准备

#### 安装JDK
```bash
# CentOS
yum install java-1.8.0-openjdk-devel

# Ubuntu
apt-get install openjdk-8-jdk
```

#### 安装Maven
```bash
wget https://archive.apache.org/dist/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz
tar -xzf apache-maven-3.8.6-bin.tar.gz
mv apache-maven-3.8.6 /usr/local/maven
export PATH=/usr/local/maven/bin:$PATH
```

#### 安装Docker（可选）
```bash
curl -fsSL https://get.docker.com | bash
systemctl start docker
systemctl enable docker
```

### 3. 数据库部署

#### MySQL配置
```bash
# 创建数据库
mysql -u root -p < sql/init.sql

# 配置主从复制（可选）
# 配置读写分离（可选）
```

#### Redis配置
```bash
# 单机模式
redis-server /etc/redis/redis.conf

# 集群模式（可选）
redis-cli --cluster create node1:6379 node2:6379 node3:6379
```

### 4. 服务注册中心部署

#### Nacos集群部署
```bash
# 下载Nacos
wget https://github.com/alibaba/nacos/releases/download/2.2.0/nacos-server-2.2.0.tar.gz
tar -xzf nacos-server-2.2.0.tar.gz

# 配置集群
vim nacos/conf/cluster.conf
# 添加节点IP

# 启动Nacos
sh nacos/bin/startup.sh
```

### 5. 微服务部署

#### 方式一：JAR包部署

```bash
# 1. 编译打包
mvn clean package -DskipTests

# 2. 上传JAR包到服务器
scp gateway/target/gateway-1.0.0.jar user@server:/opt/apps/
scp auth-service/target/auth-service-1.0.0.jar user@server:/opt/apps/
# ... 其他服务

# 3. 启动服务
nohup java -jar gateway-1.0.0.jar > gateway.log 2>&1 &
nohup java -jar auth-service-1.0.0.jar > auth-service.log 2>&1 &
# ... 其他服务
```

#### 方式二：Docker部署

```bash
# 1. 构建镜像
docker build -t ddd-gateway:1.0.0 gateway/
docker build -t ddd-auth:1.0.0 auth-service/
# ... 其他服务

# 2. 运行容器
docker run -d -p 8080:8080 --name gateway ddd-gateway:1.0.0
docker run -d -p 8081:8081 --name auth-service ddd-auth:1.0.0
# ... 其他服务
```

#### 方式三：Kubernetes部署

```bash
# 1. 创建命名空间
kubectl create namespace ddd

# 2. 部署服务
kubectl apply -f k8s/gateway-deployment.yaml
kubectl apply -f k8s/auth-service-deployment.yaml
# ... 其他服务

# 3. 创建服务
kubectl apply -f k8s/gateway-service.yaml
kubectl apply -f k8s/auth-service-service.yaml
# ... 其他服务
```

### 6. 负载均衡配置

#### Nginx配置
```nginx
upstream gateway {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 7. 监控配置

#### Prometheus + Grafana
```bash
# 安装Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz

# 配置监控目标
vim prometheus.yml

# 启动Prometheus
./prometheus --config.file=prometheus.yml
```

#### 应用监控
- 使用Spring Boot Actuator
- 集成Micrometer
- 配置告警规则

### 8. 日志配置

#### ELK Stack
```bash
# 安装Elasticsearch
docker run -d -p 9200:9200 -p 9300:9300 elasticsearch:7.17.0

# 安装Logstash
docker run -d -p 5044:5044 logstash:7.17.0

# 安装Kibana
docker run -d -p 5601:5601 kibana:7.17.0
```

#### 日志收集
- 使用Filebeat收集日志
- 配置日志格式
- 设置日志轮转

### 9. 安全配置

#### SSL/TLS配置
```bash
# 申请证书
certbot certonly --standalone -d api.example.com

# Nginx配置HTTPS
server {
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/api.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.example.com/privkey.pem;
}
```

#### 防火墙配置
```bash
# 开放必要端口
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --permanent --add-port=8848/tcp
firewall-cmd --reload
```

### 10. 备份策略

#### 数据库备份
```bash
# 定时备份脚本
#!/bin/bash
mysqldump -u root -p ddd_auth > /backup/ddd_auth_$(date +%Y%m%d).sql
```

#### 配置文件备份
- 使用Git管理配置
- 定期备份Nacos配置
- 备份Redis数据

## 三、高可用部署

### 1. 服务高可用
- 每个服务至少部署2个实例
- 使用负载均衡
- 配置健康检查

### 2. 数据库高可用
- MySQL主从复制
- 读写分离
- 数据备份

### 3. 缓存高可用
- Redis哨兵模式
- Redis集群模式

### 4. 消息队列高可用
- RocketMQ集群部署
- 多副本存储

## 四、性能优化

### 1. JVM参数优化
```bash
java -Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 \
     -jar app.jar
```

### 2. 数据库优化
- 索引优化
- 查询优化
- 连接池配置

### 3. 缓存优化
- 缓存预热
- 缓存穿透防护
- 缓存雪崩防护

## 五、故障处理

### 1. 服务故障
- 查看日志: `tail -f logs/*.log`
- 检查服务状态: `ps aux | grep java`
- 重启服务: `./stop.sh && ./start.sh`

### 2. 数据库故障
- 检查连接: `mysql -u root -p`
- 查看慢查询日志
- 检查磁盘空间

### 3. 网络故障
- 检查网络连接: `ping`
- 检查端口: `netstat -tlnp`
- 检查防火墙规则

## 六、运维监控

### 1. 健康检查
```bash
# 服务健康检查
curl http://localhost:8080/actuator/health

# 数据库健康检查
mysqladmin -u root -p ping
```

### 2. 性能监控
- CPU使用率
- 内存使用率
- 磁盘IO
- 网络流量

### 3. 告警配置
- 服务异常告警
- 资源使用告警
- 业务指标告警

