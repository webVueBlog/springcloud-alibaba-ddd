# 数据库设计文档

## 一、数据库ER图概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户体系模块                                │
├─────────────────────────────────────────────────────────────────┤
│ sys_user (用户表)                                                │
│ sys_user_extend (用户扩展信息)                                    │
│ sys_user_role (用户角色关联)                                      │
│ sys_user_follow (用户关注)                                        │
│ sys_email_verify (邮箱验证)                                       │
│ sys_password_reset (密码重置)                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        权限体系模块                                │
├─────────────────────────────────────────────────────────────────┤
│ sys_role (角色表)                                                │
│ sys_permission (权限表)                                           │
│ sys_role_permission (角色权限关联)                                │
│ sys_menu (菜单表)                                                │
│ sys_menu_permission (菜单权限关联)                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        内容体系模块                                │
├─────────────────────────────────────────────────────────────────┤
│ content_category (内容分类)                                       │
│ content_tag (内容标签)                                            │
│ content_article (文章表)                                          │
│ content_article_tag (文章标签关联)                                │
│ content_article_version (文章历史版本)                            │
│ content_topic (专题表)                                            │
│ content_topic_article (专题文章关联)                              │
│ content_comment (评论表)                                          │
│ content_boiling_point (沸点表)                                    │
│ content_article_like (文章点赞)                                   │
│ content_article_collect (文章收藏)                                │
│ content_comment_like (评论点赞)                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        统计分析模块                                │
├─────────────────────────────────────────────────────────────────┤
│ statistics_event_log (事件日志)                                  │
│ statistics_visit_daily (每日访问统计)                             │
│ statistics_source_channel (来源渠道统计)                          │
│ statistics_content_ranking (内容排行统计)                         │
│ statistics_user_profile (用户画像统计)                            │
│ statistics_tag_hot (标签热度统计)                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        审计日志模块                                │
├─────────────────────────────────────────────────────────────────┤
│ sys_audit_log (系统审计日志)                                      │
└─────────────────────────────────────────────────────────────────┘
```

## 二、核心表结构说明

### 2.1 用户体系

#### sys_user (用户表)
- 基础用户信息：用户名、密码、手机号、邮箱、微信OpenID/UnionID
- 状态管理：status（正常/禁用）、deleted（逻辑删除）

#### sys_user_extend (用户扩展信息)
- 个人资料：昵称、头像、简介、性别、生日、所在地
- 职业信息：公司、职位
- 社交信息：个人网站、GitHub、微博
- 技术栈：JSON数组格式存储

#### sys_email_verify (邮箱验证)
- 支持注册、重置密码、修改邮箱三种场景
- 验证码有效期管理
- 防重复使用机制

#### sys_password_reset (密码重置)
- 重置令牌机制
- 过期时间管理
- IP地址记录

### 2.2 权限体系

#### sys_role (角色表)
- 角色编码、名称、描述
- 状态管理

#### sys_permission (权限表)
- **权限类型**：
  - BUTTON：按钮权限（控制前端按钮、菜单显示）
  - DATA：数据权限（控制数据访问范围）
- 资源路径、请求方法
- 权限编码、名称

#### sys_menu (菜单表)
- 树形结构（parent_id）
- 菜单编码、名称、路径、图标
- 排序号

#### sys_menu_permission (菜单权限关联)
- 菜单与权限的多对多关系
- 支持菜单级权限控制

### 2.3 内容体系

#### content_article (文章表)
- **发布状态**：DRAFT（草稿）、PUBLISHED（已发布）、OFFLINE（已下架）
- **访问级别**：PUBLIC（公开）、PRIVATE（私有）、PAID（付费可见）、SPECIFIED（指定用户可见）
- **内容类型**：MARKDOWN、RICH_TEXT
- 统计字段：阅读数、点赞数、评论数、收藏数、分享数
- 版本号：支持历史版本回溯
- 全文索引：title、summary

#### content_article_version (文章历史版本)
- 版本号管理
- 历史内容保存
- 支持版本对比和回滚

#### content_topic (专题表)
- 专题名称、编码、封面、描述
- 访问级别控制
- 文章数量、关注数统计

#### content_comment (评论表)
- **目标类型**：ARTICLE（文章）、COMMENT（评论回复）
- **审核状态**：PENDING（待审核）、APPROVED（已通过）、REJECTED（已拒绝）
- 多级回复支持（parent_id）
- 点赞数、回复数统计

#### content_boiling_point (沸点表)
- 短内容发布
- 支持多图片（JSON数组）
- 审核机制

### 2.4 统计分析

#### statistics_event_log (事件日志)
- **事件类型**：VIEW、CLICK、LIKE、COMMENT、SHARE、SEARCH等
- **事件分类**：ARTICLE、TOPIC、BOILING_POINT、COURSE等
- 用户行为追踪：IP、User-Agent、Referer
- 设备信息：设备类型、操作系统、浏览器
- 会话ID：用于用户行为分析
- 扩展数据：JSON格式存储

#### statistics_visit_daily (每日访问统计)
- PV（页面访问量）
- UV（独立访客数）
- IP数、新用户数
- 跳出率、平均访问时长、平均访问页数

#### statistics_source_channel (来源渠道统计)
- **渠道类型**：NATURAL（自然流量）、PAID（付费投放）、SOCIAL（社交分享）、SEARCH（搜索引擎）、DIRECT（直接访问）
- 访问次数、用户数统计

#### statistics_content_ranking (内容排行统计)
- 按内容类型统计
- 热度分数计算（综合浏览量、点赞、评论、分享）
- 排名管理

#### statistics_user_profile (用户画像统计)
- 访问次数、最后访问时间
- 关注标签、分类
- 互动次数统计
- 内容发布统计
- 粉丝数、关注数

#### statistics_tag_hot (标签热度统计)
- 使用次数、浏览量
- 热度分数计算
- 排名管理

### 2.5 审计日志

#### sys_audit_log (系统审计日志)
- **操作类型**：CREATE、UPDATE、DELETE、VIEW、LOGIN、LOGOUT等
- **操作模块**：USER、ROLE、PERMISSION、ARTICLE、TOPIC等
- 操作人信息：用户ID、用户名
- 目标信息：目标类型、ID、名称
- 变更记录：变更前值、变更后值、变更字段
- 请求信息：IP、User-Agent、请求方法、URL、参数
- 操作状态：成功/失败、错误信息、执行时间

## 三、权限模型设计

### 3.1 功能权限（BUTTON）
- 菜单权限：控制菜单显示/隐藏
- 按钮权限：控制按钮操作（增删改查、审核、发布等）
- 通过 `sys_menu_permission` 关联菜单和权限
- 通过 `sys_role_permission` 关联角色和权限

### 3.2 数据权限（DATA）
- **全部数据**：可查看所有数据
- **部门数据**：只能查看本部门数据（需扩展部门表）
- **自己数据**：只能查看自己的数据
- 通过权限类型 `DATA` 标识
- 在Service层进行数据过滤

### 3.3 访问级别控制
- **PUBLIC**：公开访问
- **PRIVATE**：私有（仅作者可见）
- **PAID**：付费可见
- **SPECIFIED**：指定用户/组织可见（需扩展关联表）

## 四、索引设计

### 4.1 主键索引
- 所有表使用 `id` 作为主键，AUTO_INCREMENT

### 4.2 唯一索引
- 用户名、手机号、邮箱（用户表）
- 角色编码、权限编码、菜单编码
- 标签编码、专题编码
- 用户角色关联、角色权限关联等

### 4.3 普通索引
- 外键字段：user_id、role_id、article_id等
- 状态字段：status、publish_status、audit_status
- 时间字段：create_time、publish_time
- 统计字段：view_count、like_count（降序）

### 4.4 全文索引
- 文章表：title、summary
- 沸点表：content

## 五、数据权限实现方案

### 5.1 数据权限过滤
在Service层根据用户权限进行数据过滤：

```java
// 示例：根据数据权限过滤文章列表
if (hasPermission("ARTICLE_DATA_ALL")) {
    // 查询所有文章
} else if (hasPermission("ARTICLE_DATA_SELF")) {
    // 只查询自己的文章
    queryWrapper.eq("user_id", currentUserId);
}
```

### 5.2 访问级别控制
在Controller层或Service层进行访问级别校验：

```java
// 示例：检查文章访问权限
if (article.getAccessLevel().equals("PRIVATE") && !article.getUserId().equals(currentUserId)) {
    throw new BusinessException("无权限访问");
}
```

## 六、扩展建议

1. **部门组织架构**：如需部门数据权限，可扩展 `sys_dept` 表
2. **付费内容**：可扩展 `content_payment` 表记录付费记录
3. **消息通知**：可扩展 `sys_notification` 表
4. **积分系统**：可扩展 `sys_user_points` 表
5. **课程/直播**：可扩展 `content_course`、`content_live` 表

