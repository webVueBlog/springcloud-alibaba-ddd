<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.content.infrastructure.mapper.ArticleMapper">
    
    <select id="findByCondition" resultType="com.example.content.infrastructure.po.ArticlePO">
        SELECT * FROM content_article
        WHERE deleted = 0
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        <if test="categoryId != null">
            AND category_id = #{categoryId}
        </if>
        <if test="publishStatus != null and publishStatus != ''">
            AND publish_status = #{publishStatus}
        </if>
        <if test="title != null and title != ''">
            AND title LIKE CONCAT('%', #{title}, '%')
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY 
        <choose>
            <when test="orderBy != null and orderBy == 'viewCount'">
                view_count DESC, create_time DESC
            </when>
            <when test="orderBy != null and orderBy == 'publishTime'">
                publish_time DESC, create_time DESC
            </when>
            <when test="orderBy != null and orderBy == 'likeCount'">
                like_count DESC, create_time DESC
            </when>
            <otherwise>
                is_top DESC, publish_time DESC, create_time DESC
            </otherwise>
        </choose>
    </select>
    
    <update id="incrementViewCount">
        UPDATE content_article
        SET view_count = view_count + 1
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <update id="incrementLikeCount">
        UPDATE content_article
        SET like_count = like_count + 1
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <update id="decrementLikeCount">
        UPDATE content_article
        SET like_count = GREATEST(like_count - 1, 0)
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <update id="incrementCommentCount">
        UPDATE content_article
        SET comment_count = comment_count + 1
        WHERE id = #{id} AND deleted = 0
    </update>
    
    <update id="decrementCommentCount">
        UPDATE content_article
        SET comment_count = GREATEST(comment_count - 1, 0)
        WHERE id = #{id} AND deleted = 0
    </update>
    
</mapper>

