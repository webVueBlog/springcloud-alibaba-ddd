# 数据权限控制实现说明

## 一、实现概述

已实现完整的数据权限控制系统，包括功能权限和数据权限两部分。

## 二、核心组件

### 2.1 权限模型

#### Permission（权限模型）
- **权限类型**：
  - `BUTTON`：按钮权限（控制前端按钮、菜单显示）
  - `DATA`：数据权限（控制数据访问范围）

#### AccessLevel（访问级别枚举）
- `PUBLIC`：公开访问（所有人都可以访问）
- `PRIVATE`：私有访问（仅作者本人可以访问）
- `PAID`：付费可见（需要付费后才能访问）
- `SPECIFIED`：指定用户可见（只有指定的用户或组织可以访问）

### 2.2 数据权限服务

#### DataPermissionService
提供数据权限检查和过滤功能：

```java
// 检查用户是否有访问指定内容的权限
boolean checkContentAccess(String accessLevel, Long contentUserId, Long currentUserId, List<String> userPermissions)

// 检查并抛出异常（如果没有权限）
void checkContentAccessOrThrow(String accessLevel, Long contentUserId, Long currentUserId, List<String> userPermissions)
```

### 2.3 数据权限注解

#### @DataPermission
用于标记需要数据权限控制的方法：

```java
@DataPermission(
    value = "ARTICLE_DATA_ALL",  // 权限编码
    type = DataPermissionType.ALL,  // 数据权限类型
    resourceField = "userId"  // 资源字段名
)
```

#### DataPermissionType（数据权限类型枚举）
- `ALL`：全部数据权限
- `DEPT`：部门数据权限
- `SELF`：自己数据权限

### 2.4 AOP 切面

#### DataPermissionAspect
拦截带有 `@DataPermission` 注解的方法，进行数据权限检查。

## 三、内容访问级别控制

### 3.1 ArticleService 增强

在 `ArticleService` 中添加了访问级别控制：

1. **getArticleById**：获取文章时检查访问权限
   - 支持传递当前用户ID和权限列表
   - 根据文章的 `accessLevel` 进行权限检查

2. **getArticleList**：查询文章列表时过滤无权限的文章
   - 自动过滤用户无权访问的文章
   - 支持公开、私有、付费、指定用户等访问级别

### 3.2 ArticleController 增强

在 `ArticleController` 中添加了用户信息传递：

1. **请求头支持**：
   - `X-User-Id`：当前用户ID
   - `X-User-Permissions`：用户权限列表（逗号分隔）

2. **自动解析权限**：
   - 从请求头解析用户ID和权限列表
   - 传递给 Service 层进行权限检查

## 四、前端实现

### 4.1 API 请求拦截器

在 `user-web/src/api/request.ts` 中：

1. **自动添加用户信息**：
   - 从 localStorage 读取用户信息
   - 自动添加到请求头 `X-User-Id` 和 `X-User-Permissions`

2. **权限信息传递**：
   - 登录后保存用户权限信息
   - 每次请求自动携带权限信息

### 4.2 用户状态管理

在 `user-web/src/store/index.ts` 中：

1. **用户信息持久化**：
   - 登录后保存用户信息到 localStorage
   - 页面刷新后自动恢复用户信息

2. **权限信息管理**：
   - 支持保存和读取用户权限列表
   - 自动传递给后端进行权限检查

### 4.3 页面显示修复

修复了 `user-web` 前端页面显示问题：

1. **使用 Element Plus 容器组件**：
   - 使用 `el-container`、`el-header`、`el-main` 等组件
   - 确保页面布局正确

2. **样式优化**：
   - 修复 header 高度和行高
   - 确保页面正常显示

## 五、使用示例

### 5.1 后端使用

```java
// 在 Service 中检查访问权限
Article article = articleRepository.findById(id);
dataPermissionService.checkContentAccessOrThrow(
    article.getAccessLevel(),
    article.getUserId(),
    currentUserId,
    userPermissions
);
```

### 5.2 前端使用

前端无需特殊处理，API 请求会自动携带用户信息：

```typescript
// 自动携带用户ID和权限信息
const articles = await articleApi.getArticleList({ publishStatus: 'PUBLISHED' })
```

## 六、权限检查流程

1. **前端请求**：
   - 用户发起请求
   - 请求拦截器自动添加用户ID和权限信息到请求头

2. **后端接收**：
   - Controller 从请求头获取用户ID和权限列表
   - 传递给 Service 层

3. **权限检查**：
   - Service 调用 `DataPermissionService` 检查访问权限
   - 根据内容的 `accessLevel` 进行权限验证

4. **结果返回**：
   - 有权限：返回数据
   - 无权限：抛出 `BusinessException`，返回错误信息

## 七、扩展建议

1. **付费内容检查**：
   - 实现付费记录表 `content_payment`
   - 在 `DataPermissionService.checkContentAccess` 中检查付费记录

2. **指定用户列表**：
   - 实现 `content_access_user` 关联表
   - 存储指定用户可见的内容列表

3. **部门数据权限**：
   - 扩展部门表 `sys_dept`
   - 实现部门数据权限过滤逻辑

4. **权限缓存**：
   - 使用 Redis 缓存用户权限信息
   - 提高权限检查性能

## 八、总结

已实现完整的数据权限控制系统，包括：

✅ **功能权限**：按钮权限、菜单权限  
✅ **数据权限**：全部数据、部门数据、自己数据  
✅ **访问级别控制**：公开、私有、付费、指定用户  
✅ **前端集成**：自动传递用户信息和权限  
✅ **后端验证**：Service 层权限检查和过滤  

系统已具备完整的数据权限控制能力，可以支持不同角色的数据访问需求。

